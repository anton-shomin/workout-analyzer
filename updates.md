Привет. Я проанализировал твой проект как команда разработки. Мы нашли критические ошибки, из-за которых ты получаешь галлюцинации от LLM (например, про 230 минут тренировки и перетренированность), и архитектурные проблемы в коде.

Вот подробный разбор.

---

### Часть 1. Отчет специалиста по LLM (Prompt Engineer)

Твоя главная проблема — принцип **Garbage In, Garbage Out (Мусор на входе — мусор на выходе)**. LLM (Groq/Llama) не "сошла с ума", она честно проанализировала те цифры, которые ты ей скормил.

#### 1. Почему LLM пишет про 230 минут, хотя в файле 20 минут?

В файле `2026-02-10.md` в блоке "Общая информация" написано `Время: ~20.0 минут` (это посчитал `main.py` -> `calorie_calculator`). **НО** в промпт для нейросети улетает совсем другая цифра.

Смотрим файл `ai/prompts.py` :

```python
def build_workout_prompt(workout_data, ...):
    # ...
    # ПРОБЛЕМА ЗДЕСЬ: Ты заново пересчитываешь время внутри генератора промпта
    # по формуле для обычных сетов, игнорируя логику EMOM.
    estimated_time = (
        total_reps * time_per_rep / 60 +
        (total_reps / max(len(reps_per_set), 1) - 1) * rest_between / 60
    )

```

**Математика ошибки:**

- У тебя 220 повторений.
- Парсер, вероятно, не разбил их на сеты корректно для этой формулы, поэтому `len(reps_per_set)` равен 1.
- `rest_between` по умолчанию = 60 секунд.
- Считаем отдых: `(220 / 1 - 1) * 60 / 60` = **219 минут отдыха**.
- Плюс время работы. Итог: ~230 минут.

Ты отправляешь в LLM текст: _"Проанализируй тренировку... Время: 230 минут"_. Модель видит EMOM на 4 упражнения, который длился 4 часа, и логично делает вывод: "Вы сошли с ума, это перетренировка".

#### 2. Проблема с "Балансом мышц" (Hallucinations)

В файле `2026-02-10.md` указано:

- `Грудь: 0.0%`
- `Плечи: 25.0%`

Модель Llama-3.3 видит эти сухие цифры и начинает их интерпретировать буквально. Gemini (Web) лучше, потому что у неё больше "здравого смысла" и она игнорирует глупые вводные. Llama более послушная: если сказали 0% груди, она советует качать грудь, даже если в упражнении `Burpee` или `Press` грудь косвенно работала.

Твой алгоритм подсчета процентов (`calculators/calorie_calculator.py`) считает **количество упоминаний** мышцы, а не объем нагрузки.

- _Пример:_ Сделал 1 тяжелый жим (Плечи) и 100 легких приседаний (Ноги). Твой код скажет: 50% Плечи, 50% Ноги. Это вводит LLM в заблуждение.

#### 3. Слабый System Prompt

В `ai/groq_client.py` системный промпт слишком простой:
`"You are an expert fitness coach specializing in kettlebell training. Provide structured, markdown-formatted analysis."`

Этого мало. Модели нужно дать контекст твоей методологии (CrossFit/Гиревой спорт), иначе она будет судить по стандартам бодибилдинга (где 20 минут тренировки — это мало).

---

### Часть 2. Отчет Senior Python Developer (Code Review)

Архитектура проекта неплохая (разделение на парсеры, клиенты, врайтеры), но реализация страдает от дублирования логики и жестких привязок.

#### 1. Исправление дублирования логики времени (Critical)

Ты считаешь время в `parser`, потом в `calculator`, а потом третий раз (и неправильно) в `prompts.py`.

**Решение:**
Передай уже посчитанное время из `workout_data` или `calorie_calculator` прямо в функцию промпта.

**Изменения в `ai/prompts.py`:**

```python
def build_workout_prompt(
    workout_data: dict,
    calories: int,
    muscle_balance: dict,
    # ДОБАВИТЬ ЭТОТ АРГУМЕНТ:
    actual_duration_minutes: int = 0
) -> str:
    # ... (код получения данных)

    # УДАЛИТЬ или ЗАКОММЕНТИРОВАТЬ старый блок расчета estimated_time
    # Вместо него использовать переданное значение или значение из парсера

    final_time = actual_duration_minutes
    if final_time == 0:
         # Пытаемся взять из workout_data, если парсер нашел duration
         final_time = workout_data.get('duration', 0)

    # Если все еще 0, тогда используем fallback формулу,
    # НО исправленную (учитывая sets, а не total_reps для отдыха)
    if final_time == 0:
        # Fallback logic...
        pass

    prompt = f"""...
    **Метрики:**
    - Примерное время: {int(final_time)} минут
    ..."""

```

Не забудь обновить вызов этой функции в `main.py` и клиентах (`ai/gemini_client.py`, `ai/groq_client.py`), прокинув туда `calories_result['estimated_time_minutes']`.

#### 2. Улучшение подсчета баланса мышц

В `calculators/calorie_calculator.py` метод `calculate_muscle_balance` считает просто `counts[mg] += 1`.

**Предложение:** Считать "вес" мышцы через повторения.

```python
# Было:
# counts[mg] += 1

# Стало (примерно):
reps = data.get('reps', 0)
# Если reps это список (лесенка), суммируем
total_reps_ex = sum(reps) if isinstance(reps, list) else reps

for mg in exercise_muscle_groups:
    # Добавляем количество повторений в зачет мышцы
    counts[mg] = counts.get(mg, 0) + total_reps_ex

```

Это даст гораздо более точную картину для LLM.

#### 3. Безопасность API ключей в логах

В файле `firebase-debug.log` (хоть он и не относится к коду напрямую, но был загружен) и при выводе ошибок ты иногда можешь засветить лишнее. Убедись, что в `main.py` при принте ошибок не выводится полный traceback с переменными окружения, если там есть ключи.

#### 4. Hardcoded Prompts

Промпты "зашиты" в код Python (`ai/prompts.py`). Это неудобно править.
**Решение:** Вынеси текст промпта в отдельный файл `templates/prompt_workout.txt` или используй Jinja2. Это позволит тебе менять "личность" тренера без изменения кода.

#### 5. Обработка EMOM в парсере (`parsers/workout_parser.py`)

Функция `_parse_duration` и логика в `parse_workout_file` пытается угадать duration.
В файле EMOM ты пишешь `duration: 1мин`. Парсер видит "1 мин", видит 20 кругов. В коде есть эвристика:

```python
if sets > 1 and val < (sets * 0.5):
    duration = val * sets

```

Для 1 минуты и 20 сетов: `1 < 10` -> `True`. Duration становится 20. Тут все верно. Ошибка именно в том, что `ai/prompts.py` игнорирует этот расчет.

### Итоговый план действий

1. **Срочно:** В `main.py` ты уже получаешь `calories_result`, где есть правильное время (`estimated_time_minutes`). Передай это значение в `gemini_client.analyze_workout` и `groq_client.analyze_workout`.
2. **Срочно:** Обнови сигнатуру методов `analyze_workout` в клиентах и функцию `build_workout_prompt` в `prompts.py`, чтобы они принимали готовое время, а не пересчитывали его.
3. **Prompt Engineering:** Обнови промпт в `ai/prompts.py`. Добавь контекст:

   > "Ты опытный тренер по функциональному многоборью и гиревому спорту. Твоя задача — оценить тренировку с точки зрения атлета, а не бодибилдера. Учти, что для EMOM высокая плотность работы — это норма."

4. **Refactor:** Перепиши логику `muscle_balance`, чтобы она учитывала количество повторений (Volume Weighted).
